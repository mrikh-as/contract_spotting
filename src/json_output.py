import json
import logging
import os

from dotenv import find_dotenv, load_dotenv
from openai import OpenAI

load_dotenv(find_dotenv())
api_key = os.environ["api_key"]

logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)
formatter = logging.Formatter("%(asctime)s - %(levelname)s - %(message)s")
handler = logging.StreamHandler()
handler.setFormatter(formatter)
logger.addHandler(handler)

# Вызов модели

from openai import OpenAI

client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")

user_input = """{
"Исполнитель": "1.1. Исполнитель обязуется собственными либо привлеченными силами оказать услуги в соответствии с условиями настоящего Договора, Заявками Заказчика, а также приложениями к настоящему Договору.",
"Заказчик": "1.1. Заказчик обязуется создать Исполнителю необходимые условия для оказания услуг.",
"Заказчик": "1.1. Заказчик обязуется оплатить обусловленную Договором цену.",
"Стороны": "1.3. Стороны пришли к соглашению, что объем услуг, указанный в соответствующих приложениях, не является окончательным и в процессе выполнения по соглашению сторон может быть изменен в соответствии с потребностями Заказчика.",
"Стороны": "1.3. Стороны пришли к соглашению, что изменение объема услуг влечет соразмерное изменение общей стоимости этих услуг.",
"Стороны": "1.3. Стороны пришли к соглашению, что фактический объем оказанных услуг и их окончательная стоимость определяются по окончании периода их выполнения и фиксируются в Акте об оказанных услугах по форме Приложения №3.",
"Стороны": "1.4. Стороны договорились признавать отчетным периодом следующий календарный период: с 01 по 15 число календарного месяца включительно; с 16 по последнее число текущего календарного месяца включительно.",
"Исполнитель": "2.1.1. Исполнитель имеет право привлекать третьих лиц (Соисполнителей) для оказания услуг, указанных в п.1.2 Договора.",
"Заказчик и Соисполнители": "2.1.1. Заказчик и Соисполнители не имеют права предъявлять друг другу требования, связанные с нарушением договоров, заключенных каждым из них с Исполнителем.",
"Исполнитель": "2.1.2. Исполнитель вправе направлять Заказчику для рассмотрения предложения по повышению эффективности оказания услуг, являющихся предметом настоящего Договора.",
"Исполнитель": "2.1.3. Исполнитель вправе сообщать для печати, в публичные и рекламные объявления, информацию о факте взаимодействия с Заказчиком при этом не разглашая конфиденциальную информацию.",
"Исполнитель": "2.1.3. Исполнитель вправе использовать Товарные знаки и коммерческие обозначения Заказчика исключительно в рекламных целях с целью продвижения своих услуг на рынке с целью оказания качественных услуг Заказчику.",
"Заказчик": "2.1.3. Заказчик дает свое разрешение на использование Товарных знаков и коммерческих обозначений Исполнителем.",
"Исполнитель": "2.1.3. Исполнитель настоящим признает, что не имеет права на товарные знаки и фирменные наименования Заказчика и соглашается не предъявлять требования относительно таких прав, не оспаривать и не участвовать в оспаривании другими лицами прав собственности на такие товарные знаки, или действительности их регистрации, как в течение срока действия Договора, а также после его прекращения в течение неограниченного времени.",
"Исполнитель": "2.1.3. Исполнитель несет полную ответственность за нарушение исключительных прав Заказчика и/или третьих лиц.",
"Исполнитель": "2.2.1. Исполнитель обязан оказывать услуги в объеме, указанном в Заявках Заказчика, и согласованном Исполнителем, включая заявки с увеличением, а также заявки со снижением от согласованного объема.",
"Исполнитель": "2.2.2. Исполнитель обязан оперативно принимать поступающие от Заказчика по электронной почте уведомления, своевременно, в течение не более 24-ти (двадцати четырех) рабочих часов, в зависимости от содержания уведомления, направлять ответ о предпринимаемых мерах к устранению нарушений.",
"Исполнитель": "2.2.3. Исполнитель обязан расследовать и учитывать несчастные случаи с Соисполнителями в соответствии с порядком, установленным действующим законодательством.",
"Исполнитель": "2.2.4. Исполнитель обязан экономно использовать коммунальные ресурсы Заказчика.",
"Исполнитель": "2.2.5. Исполнитель обязан предоставлять Акт сверки взаимных расчетов между Заказчиком и Исполнителем по запросу Заказчика.",
"Исполнитель": "2.2.6. Исполнитель обязан при оказании услуг обеспечить соблюдение мер по технике безопасности и пожарной безопасности в соответствии с требованиями действующего законодательства РФ.",
"Исполнитель": "2.2.7. Исполнитель обязан оказывать услуги безопасными способами и соблюдать требования действующего законодательства.",
"Исполнитель": "2.2.8. Исполнитель обязан обеспечить соблюдение Соисполнителями Правил поведения, действующих на объекте Заказчика.",
"Заказчик": "2.2.8. Заказчик обязан довести до сведения Исполнителя данные правила до начала оказания услуг.",
"Исполнитель": "2.2.8. Исполнитель обязан во время оказания услуг не допускать нарушения технологических процессов по вине Соисполнителей.",
"Исполнитель": "2.2.9. Исполнитель обязан в случае необходимости гарантировать Заказчику, а также обеспечить и контролировать наличие действующих санитарных/медицинских книжек у Соисполнителей, оказывающих услуги по настоящему Договору.",
"Исполнитель": "2.2.10. Исполнитель обязан в случае оказания услуг Соисполнителями - иностранными гражданами, проконтролировать наличие полного комплекта разрешительной документации для оказания услуг такой категорией граждан на территории Российской Федерации, оформленной в соответствии с действующим законодательством РФ.",
"Исполнитель": "2.2.11. Исполнитель обязан обеспечить прохождение Соисполнителями инструктажей пожарной безопасности, технике безопасности; допускать к оказанию услуг лиц, прошедших соответствующее обучение и инструктаж по качеству выполнения работ, правил поведения на объекте оказания услуг, санитарных норм и правил, о чем сделать отметку в журнале регистрации инструктажей Исполнителя, а также обеспечить выполнение Соисполнителями вышеперечисленных требований.",
"Исполнитель": "2.2.12. Исполнитель обязан назначить лиц, уполномоченных подписывать на объекте оказания услуг претензионные, отчетные и/ или учетные документы.",
"Исполнитель": "2.2.13. Исполнитель обязан осуществлять иные мероприятия по исполнению своих обязательств перед Заказчиком.",
"Исполнитель": "2.2.14. Исполнитель обязуется не вступать в трудовые отношения с работниками Заказчика без письменного согласия Заказчика, а также с лицами, у которых срок окончания трудовых отношений с Заказчиком менее одного месяца.",
"Исполнитель": "2.2.15. Исполнитель обязан предоставлять по запросу Заказчика копии учредительных документов, сведения о налоговых отчислениях в бюджет, результаты аудиторских проверок в части, касающейся взаимоотношений с Заказчиком в рамках настоящего Договора и иные документы, подтверждающие соблюдение Исполнителем всех условий настоящего Договора, не позднее 30 (тридцати) дней с даты получения соответствующего запроса.",
"Исполнитель": "2.2.16. Исполнитель обязан в случае необходимости соблюдения стандартов Заказчика обеспечить форменной или специальной одеждой Соисполнителей, оказывающих услуги на объекте Заказчика, в том числе, соответствующую температурному режиму и сезону или в силу стандартов РФ, необходимой для выполнения данного вида услуг."
}
                """

# Создание списка промтов

messages = [
    {
        "role": "system",
        "content": """Ты - middle-юрист.Ты хорошо умеешь подбирать нормы права, применимые
                к условиям договоров.
                Ты хорошо знаешь, что в силу ГК РФ условия договора определяются по усмотрению сторон,
                кроме случаев, когда содержание соответствующего условия предписано законом. В последнем
                случае договор должен соответствовать обязательным для сторон правилам, установленным законом
                (императивным нормам).
                Ранее специалист в области обработки естественного языка (nlp) для твоего удобства
                извлек из фрагмента договора простые предложения, каждое из которых является
                правом или обязанностью одной или нескольких сторон по договору.
                Тебе нужно проверить, предписано ли законом РФ (в частности - ГК РФ) содержание того или иного права или обязанности
                из фрагмента договора. Если предписано - нужно указать релевантное положение закона. Если нет - не выдумывай и прямо скажи,
                что релевантное положение закона отсутствует.
                Ответ дай в формате json.
                Пример полученных тобой прав и обязанностей:
                    {
                    "Перевозчик": "2.3. Перевозчик в случае утраты груза возмещает ущерб и провозную плату.",
                    "Продавец": "1.3. Продавец освобождается от ответственности за истребование товара у покупателя третьими лицами.",
                    "Подрядчик": "3.1. Подрядчик обязан выполнить работу лично, без привлечения третьих лиц.",
                    "Займодавец": "5.3. Замодавец имеет право на проценты за пользование займом.",
                    "Арендодатель": "4.1. Арендодатель вправе осуществлять проверки чистоты арендованного помещения.",
                    "Исполнитель": "Исполнитель обеспечивает наличие свободных вагонов на Казанском вокзале каждый понедельник"
                    }
                Пример твоего ответа:
                    {
                    "Перевозчик": ["2.3. Перевозчик в случае утраты груза возмещает ущерб и провозную плату.", "Пункт 3 статьи 796 ГК РФ"],
                    "Продавец": ["1.3. Продавец освобождается от ответственности за истребование товара у покупателя третьими лицами.", "Пункт 2 статьи 461 ГК РФ"],
                    "Подрядчик": ["3.1. Подрядчик обязан выполнить работу лично, без привлечения третьих лиц.", "Пункт 1 статьи 706 ГК РФ"],
                    "Займодавец": ["5.3. Замодавец имеет право на проценты за пользование займом.", "Пункт 1 статьи 809 ГК РФ"]
                    "Арендодатель": ["4.1. Арендодатель вправе осуществлять проверки чистоты арендованного помещения.", "Не найдено положение закона"],
                    "Исполнитель": ["Исполнитель обеспечивает наличие свободных вагонов на Казанском вокзале каждый понедельник", "Не найдено положение закона"]
                }
                """,
    },
    {"role": "user", "content": user_input},
]


# Функция ответа модели
def extraction(user_input: str):
    """Вызов модели"""
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=messages,
        response_format={"type": "json_object"},
    )
    logger.info("Нормы права подобраны.")
    full_message = response.choices[0].message
    with open("rules.txt", "w", encoding="utf-8") as file:
        file.write(full_message.content)
    logger.info("Нормы права сохранены в файле rules.txt.")
    rules = json.loads(response.choices[0].message.content)
    return rules


report = extraction(user_input)
